
declare @MailCount int
declare @CompCount int

BEGIN TRY
BEGIN tran

	SELECT @MailCount = CarfareCount FROM S_LastBusinessDay
	WHERE LastBusinessDayID = @LastBusinessDayID

	SELECT @CompCount = COUNT(*) FROM T_Carfare
	WHERE LastBusinessDayID = @LastBusinessDayID
	 AND Status = @cStatus

	if @MailCount = @CompCount
	begin
		UPDATE S_LastBusinessDay SET Status = @lStatus
		WHERE LastBusinessDayID = @LastBusinessDayID
	end

COMMIT tran
END TRY

BEGIN CATCH

    declare @ErrorMessage nvarchar(4000)
    declare @ErrorSeverity int
    declare @ErrorState int

    SELECT @ErrorMessage = ERROR_MESSAGE(),
           @ErrorSeverity = ERROR_SEVERITY(),
           @ErrorState = ERROR_STATE()

	RAISERROR (@ErrorMessage, -- Message text.
               @ErrorSeverity, -- Severity.
               @ErrorState -- State.
               );


	ROLLBACK tran

END CATCH
